<!DOCTYPE html>
<html>
<head>
    <title>Vision</title>
    <link rel="stylesheet" href="styles/main.css">
    <link rel="stylesheet" href="styles/vision.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
</head>
<body class="theme-purple">
    <div class="window vision-window">
        <!-- Title bar -->
        <div class="title-bar">
            <div class="window-controls">
                <button class="window-control close" id="close-button">
                    <i class="fas fa-times"></i>
                </button>
                <button class="window-control minimize" id="minimize-button">
                    <i class="fas fa-minus"></i>
                </button>
            </div>
            <div class="title-bar-left">
                <div class="title-bar-logo">Vision (Beta)</div>
            </div>
        </div>

        <!-- Content -->
        <div class="vision-content">
            <!-- Model Installation Section -->
            <div id="model-install-section" class="model-install-section" style="display: none;">
                <div class="model-install-content">
                    <h2>Vision Model Required</h2>
                    <p>The llama3.2-vision:11b model is required for image analysis. Would you like to install it now?</p>
                    <div class="model-install-progress" style="display: none;">
                        <div class="progress-bar">
                            <div class="progress-fill"></div>
                        </div>
                        <div class="progress-text">0%</div>
                    </div>
                    <button id="install-model-btn" class="btn primary">
                        <i class="fas fa-download"></i>
                        Install Model
                    </button>
                </div>
            </div>

            <!-- Vision Content Section -->
            <div id="vision-main-content" class="vision-container" style="display: none;">
                <div class="vision-header">
                    <h2>Image Analysis</h2>
                    <p class="vision-description">Upload an image and specify what aspects you want to analyze. PROMPTR will generate detailed insights based on your requirements.</p>
                    
                    <!-- Prompt Input -->
                    <div class="prompt-input-container">
                        <label for="vision-prompt">Analysis Focus:</label>
                        <input type="text" id="vision-prompt" class="vision-prompt-input" 
                               value="Analyze this image and describe what you see, focusing on the main objects, their arrangement, and any notable details."
                               placeholder="e.g., 'Describe the main objects', 'Analyze the composition', 'Identify the art style'">
                    </div>
                </div>

                <!-- Main Content Area -->
                <div class="vision-main-area">
                    <!-- Left side - Drop zone -->
                    <div class="vision-left">
                        <div class="drop-zone" id="vision-drop-zone">
                            <div class="drop-zone-content">
                                <div class="drop-zone-icon">
                                    <i class="fas fa-cloud-upload-alt"></i>
                                </div>
                                <div class="drop-zone-text">
                                    <p>Drag and drop your image here</p>
                                    <span>or</span>
                                    <button class="btn primary select-btn" id="select-button">
                                        <i class="fas fa-folder-open"></i>
                                        Choose File
                                    </button>
                                </div>
                            </div>
                            <input type="file" id="file-input" accept="image/*" hidden>
                            <img id="preview-image" class="preview-image" hidden>
                        </div>
                    </div>

                    <!-- Right side - Features & Actions -->
                    <div class="vision-right">
                        <div class="vision-features">
                            <h3>Available Analysis Features:</h3>
                            <div class="feature-list">
                                <div class="vision-feature">
                                    <i class="fas fa-eye"></i>
                                    <div class="feature-info">
                                        <span class="feature-title">Scene Analysis</span>
                                        <span class="feature-desc">Detailed description of the image content</span>
                                    </div>
                                </div>
                                <div class="vision-feature">
                                    <i class="fas fa-tags"></i>
                                    <div class="feature-info">
                                        <span class="feature-title">Object Detection</span>
                                        <span class="feature-desc">Identifies key objects and elements</span>
                                    </div>
                                </div>
                                <div class="vision-feature">
                                    <i class="fas fa-palette"></i>
                                    <div class="feature-info">
                                        <span class="feature-title">Style Recognition</span>
                                        <span class="feature-desc">Analyzes artistic and visual style</span>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="vision-actions">
                            <button id="vision-button" class="btn primary" disabled>
                                <i class="fas fa-wand-magic-sparkles"></i>
                                Start Analysis
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Analysis Progress -->
            <div id="analysis-progress" class="vision-info" style="display: none;">
                <div class="analyzing-spinner"></div>
                <h2>Analyzing Image...</h2>
                <p>Please wait while we analyze your image. This may take a moment.</p>
            </div>

            <!-- Analysis Result -->
            <div id="analysis-result" class="vision-info" style="display: none;">
                <h2>Analysis Result</h2>
                <div class="result-content" id="result-content"></div>
                <div class="result-actions">
                    <button id="copy-to-prompt-btn" class="btn primary">
                        <i class="fas fa-file-import"></i>
                        Copy to Prompt
                    </button>
                    <button id="copy-to-clipboard-btn" class="btn secondary">
                        <i class="fas fa-copy"></i>
                        Copy
                    </button>
                    <button id="cancel-btn" class="btn">
                        <i class="fas fa-arrow-left"></i>
                        Back
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', async function() {
            const { ipcRenderer } = require('electron');
            
            // Check for the vision model on load
            const modelName = 'llama3.2-vision:11b';
            const modelAvailable = await ipcRenderer.invoke('check-model-availability', modelName);
            
            const modelInstallSection = document.getElementById('model-install-section');
            const visionMainContent = document.getElementById('vision-main-content');
            const installButton = document.getElementById('install-model-btn');
            const progressBar = document.querySelector('.model-install-progress');
            const progressFill = document.querySelector('.progress-fill');
            const progressText = document.querySelector('.progress-text');

            // Analysis sections
            const analysisInfo = document.getElementById('analysis-info');
            const analysisProgress = document.getElementById('analysis-progress');
            const analysisResult = document.getElementById('analysis-result');
            const resultContent = document.getElementById('result-content');

            if (!modelAvailable) {
                modelInstallSection.style.display = 'flex';
                visionMainContent.style.display = 'none';

                installButton.addEventListener('click', async () => {
                    installButton.disabled = true;
                    progressBar.style.display = 'block';

                    try {
                        await ipcRenderer.invoke('install-model', modelName);
                        modelInstallSection.style.display = 'none';
                        visionMainContent.style.display = 'flex';
                    } catch (error) {
                        console.error('Error installing model:', error);
                        alert('Failed to install model. Please try again.');
                        installButton.disabled = false;
                    }
                });

                // Listen for progress updates
                ipcRenderer.on('model-install-progress', (event, data) => {
                    const progress = typeof data === 'number' ? data : data.progress;
                    progressFill.style.width = `${progress}%`;
                    progressText.textContent = `${Math.round(progress)}%`;
                });
            } else {
                modelInstallSection.style.display = 'none';
                visionMainContent.style.display = 'flex';
            }

            // Vision window functionality
            const dragArea = document.getElementById('vision-drop-zone');
            const fileInput = document.getElementById('file-input');
            const previewImage = document.getElementById('preview-image');
            const visionButton = document.getElementById('vision-button');
            const visionPrompt = document.getElementById('vision-prompt');
            let selectedImage = null;

            dragArea.addEventListener('click', () => {
                fileInput.click();
            });

            fileInput.addEventListener('change', function() {
                const file = this.files[0];
                handleFile(file);
            });

            dragArea.addEventListener('dragover', (e) => {
                e.preventDefault();
                dragArea.classList.add('dragover');
            });

            dragArea.addEventListener('dragleave', () => {
                dragArea.classList.remove('dragover');
            });

            dragArea.addEventListener('drop', (e) => {
                e.preventDefault();
                dragArea.classList.remove('dragover');
                const file = e.dataTransfer.files[0];
                handleFile(file);
            });

            function handleFile(file) {
                if (file && file.type.startsWith('image/')) {
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        selectedImage = e.target.result;
                        previewImage.src = selectedImage;
                        previewImage.hidden = false;
                        visionButton.disabled = false;
                        
                        // Reset UI state
                        analysisInfo.style.display = 'block';
                        analysisProgress.style.display = 'none';
                        analysisResult.style.display = 'none';
                    };
                    reader.readAsDataURL(file);
                }
            }

            visionButton.addEventListener('click', async () => {
                if (selectedImage) {
                    visionButton.disabled = true;
                    analysisInfo.style.display = 'none';
                    analysisProgress.style.display = 'block';
                    analysisResult.style.display = 'none';

                    try {
                        const prompt = visionPrompt.value;
                        const result = await ipcRenderer.invoke('analyze-image', selectedImage, prompt);
                        resultContent.textContent = result;
                        analysisProgress.style.display = 'none';
                        analysisResult.style.display = 'block';
                    } catch (error) {
                        console.error('Error analyzing image:', error);
                        alert('Failed to analyze image. Please try again.');
                        analysisInfo.style.display = 'block';
                        analysisProgress.style.display = 'none';
                        visionButton.disabled = false;
                    }
                }
            });

            // Result action buttons
            document.getElementById('copy-to-prompt-btn').addEventListener('click', () => {
                ipcRenderer.send('set-prompt', resultContent.textContent);
            });

            document.getElementById('copy-to-clipboard-btn').addEventListener('click', () => {
                navigator.clipboard.writeText(resultContent.textContent);
            });

            document.getElementById('cancel-btn').addEventListener('click', () => {
                analysisResult.style.display = 'none';
                analysisInfo.style.display = 'block';
                visionButton.disabled = false;
            });

            // Window controls
            document.getElementById('close-button').addEventListener('click', () => {
                ipcRenderer.send('close-vision-window');
            });

            document.getElementById('minimize-button').addEventListener('click', () => {
                ipcRenderer.send('minimize-vision-window');
            });
        });
    </script>
</body>
</html>